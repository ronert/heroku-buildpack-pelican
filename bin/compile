#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# Fail fast and fail hard.
set -eo pipefail

# clean up leaking environment
unset GIT_DIR

if [ -z "$BUILDPACK_CACHE" ]; then BUILDPACK_CACHE="/tmp"; fi
LP_DIR=`cd $(dirname $0); cd ..; pwd`

BUILD_DIR=$1
CACHE_DIR=$2

FIXED_HOME=/app

mkdir -p $CACHE_DIR

if [ ! -e $CACHE_DIR/ghc ]; then
  GHC_URL="http://informatik.uni-kiel.de/~sad/ghc.tar.gz"
  echo "-----> Downloading GHC"
  curl -# --max-time 120 -L "$GHC_URL" | tar xz -C $CACHE_DIR
fi

# Restore GHC registry if available
if [ -e $CACHE_DIR/dotghc ]; then
  rm -rf $FIXED_HOME/app/.ghc
  mv $CACHE_DIR/dotghc $FIXED_HOME/.ghc
fi

# Fix directory
mv $CACHE_DIR/ghc $FIXED_HOME

# Restore Cabal cache or download an empty environemt
if [ -e $CACHE_DIR/cabal ]; then
  rm -rf $FIXED_HOME/.cabal
  mv $CACHE_DIR/cabal $FIXED_HOME/.cabal
elif [ ! -e $FIXED_HOME/.cabal ]; then
  CABAL_URL="http://informatik.uni-kiel.de/~sad/cabal.tar.gz"
  echo "-----> Downloading Cabal"
  curl -# --max-time 120 -L "$CABAL_URL" | tar xz -C $FIXED_HOME
fi

# Set LD_LIBRARAY_PATH and link essential libraries
mkdir -p $FIXED_HOME/usr/lib
ln -s /usr/lib/libgmp.so.3.5.2 $FIXED_HOME/usr/lib/libgmp.so
export LD_LIBRARY_PATH=$FIXED_HOME/usr/lib

# Set PATH
export PATH=$FIXED_HOME/ghc/bin:$FIXED_HOME/.cabal/bin:$PATH

echo "-----> Updating Cabal"
cabal update

echo "-----> Release the hounds! Installing application"
cd $BUILD_DIR
cabal install -j5 --disable-library-profiling --disable-executable-profiling --disable-shared

echo "-----> Caching Cabal packages"
echo $FIXED_HOME/.ghc
shopt -s extglob
#rm $FIXED_HOME/.cabal/bin/!(cabal|happy)
mv $FIXED_HOME/.cabal $CACHE_DIR/cabal
mv $FIXED_HOME/ghc $CACHE_DIR/ghc
#mv $FIXED_HOME/.ghc $CACHE_DIR/dotghc

echo "Cache dir size:"
du -ms $CACHE_DIR
echo "Build dir size:"
du -ms $BUILD_DIR


# Fail fast and fail hard.
set -eo pipefail

# Paths.
BIN_DIR=$(cd $(dirname $0); pwd) # absolute path
ROOT_DIR=$(dirname $BIN_DIR)
CACHED_DIRS=".heroku"
WORKING_DIR=$(pwd)

rm -fr $CACHE_DIR
mkdir -p $CACHE_DIR

# Versions.
PYTHON_VERSION="python-3.4.3"
PYTHON_STACK="cedar-14"
NGINX_VERSION="nginx-1.7.2"
PCRE_VERSION='pcre-8.36'
source $BIN_DIR/utils

mkdir -p $BUILD_DIR/local/sbin

if [[ ! -d "$CACHE_DIR/$PYTHON_VERSION" ]]; then
  cd $CACHE_DIR
  puts-step "Installing Python ($PYTHON_VERSION)"
  mkdir $PYTHON_VERSION
  curl https://lang-python.s3.amazonaws.com/$PYTHON_STACK/runtimes/$PYTHON_VERSION.tar.gz -s | tar zx -C $PYTHON_VERSION &> /dev/null
fi

# without setting a UTF-8 encoding, pip8 exposes a bug: https://github.com/multani/sonata/issues/72
export LANG=en_GB.utf-8

export PATH=$CACHE_DIR/$PYTHON_VERSION/bin:$PATH
export C_INCLUDE_PATH=$CACHE_DIR/$PYTHON_VERSION/include
export CPLUS_INCLUDE_PATH=$CACHE_DIR/$PYTHON_VERSION/include
export LIBRARY_PATH=$CACHE_DIR/$PYTHON_VERSION/lib
export LD_LIBRARY_PATH=$CACHE_DIR/$PYTHON_VERSION/lib

puts-step "Ensure pip"
python -m ensurepip | indent

cd $BUILD_DIR

if [[ -f requirements.txt ]]; then
  puts-step "Installing dependencies using pip"
  python -m pip install --quiet -r requirements.txt | indent
else
  puts-step "Installing Pelican"
  python -m pip install --quiet pelican | indent

  puts-step "Installing Markdown"
  python -m pip install --quiet Markdown | indent
fi

puts-step "Installing pandoc"
if ! type "pandoc" > /dev/null; then
    cabal install pandoc
fi

puts-step "Running pelican"

if [[ -f publishconf.py ]]; then
  CONFIG_FILE="publishconf.py"
elif [[ -f pelicanconf.py ]]; then
  CONFIG_FILE="pelicanconf.py"
else
  puts-warn "A pelicanconf.py or publishconf.py file is required."
  exit 1
fi

pelican -d -o $BUILD_DIR/public -s $CONFIG_FILE $BUILD_DIR/content | indent

puts-step "Installing pcre ($PCRE_VERSION)"
if [[ ! -d "$CACHE_DIR/$PCRE_VERSION" ]]; then
  cd $CACHE_DIR
  curl -L http://downloads.sourceforge.net/pcre/$PCRE_VERSION.tar.bz2 -s | tar jx &> /dev/null
fi

puts-step "Installing nginx ($NGINX_VERSION)"
if [[ ! -d "$CACHE_DIR/$NGINX_VERSION" ]]; then
  cd $CACHE_DIR
  curl http://nginx.org/download/$NGINX_VERSION.tar.gz -s | tar xz &> /dev/null
  cd $NGINX_VERSION
  ./configure --prefix=$BUILD_DIR/local \
    --with-pcre=$CACHE_DIR/$PCRE_VERSION \
    --without-select_module \
    --without-poll_module \
    --without-http_gzip_module \
    --without-http_proxy_module \
    --with-http_gzip_static_module &> /dev/null
  make -j2 &> /dev/null
fi

cd $CACHE_DIR/$NGINX_VERSION
make install &> /dev/null

mkdir -p $BUILD_DIR/.profile.d
cp $ROOT_DIR/conf/path.sh $BUILD_DIR/.profile.d/

if [[ ! -f $BUILD_DIR/nginx.conf.erb ]]; then
  cp $ROOT_DIR/conf/nginx.conf.erb $BUILD_DIR/nginx.conf.erb
fi

cp $ROOT_DIR/conf/mime.types $BUILD_DIR/
cp $BIN_DIR/launch-nginx "$BUILD_DIR/local/sbin"


